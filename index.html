<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Overstappen</title>

<style>
@font-face {
  font-family: 'FlandersArtSans';
  src: url('fonts/FlandersArtSans-Bold.woff') format('woff');
  font-weight: 600;
}
@font-face {
  font-family: 'FlandersArtSans';
  src: url('fonts/FlandersArtSans-Medium.woff') format('woff');
  font-weight: 500;
}
@font-face {
  font-family: 'FlandersArtSans';
  src: url('fonts/FlandersArtSans-Regular.woff') format('woff');
  font-weight: 400;
}

:root{
  --bg:#111;
  --text:#fff;
  --muted:#ddd;
  --accent:#FFCC11;
  --divider: rgba(255,255,255,.14);
}

*{ box-sizing: border-box; }

body{
  font-family: 'FlandersArtSans', Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  margin: 0;
  padding: 2.75% 5% 0;
  display:flex;
  flex-direction:column;
}

/* ===== Header ===== */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.title{
  font-size:3.75em;
  font-weight:500;
}

.clock{
  font-size:3.5em;
  font-weight:400;
}

/* ===== Layout ===== */
.departures{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:26px;
  margin-top:2.75%;
  flex-grow:1;
}

@media(max-width:980px){
  .departures{grid-template-columns:1fr;}
}

.list{
  display:flex;
  flex-direction:column;
  gap:22px;
}

.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 0;
}

.row + .row{
  border-top:2px solid var(--divider);
  padding-top:22px;
}

.left{
  display:flex;
  align-items:center;
  gap:22px;
  min-width:0;
}

/* lijnnummer */
.line-box{
  padding:10px 24px;
  border-radius:28px;
  font-size:2.45em;
  font-weight:600;
  line-height:1.1;
  white-space:nowrap;
  box-shadow:0 0 15px rgba(0,0,0,.25);
}

/* bestemming */
.dest{
  font-size:2.55em;
  font-weight:500;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

/* tijd */
.time{
  font-size:2.30em;
  font-weight:400;
  color:var(--muted);
  min-width:110px;
  text-align:right;
  font-variant-numeric:tabular-nums;
}
</style>
</head>

<body>

<div class="header">
  <div class="title" id="title">Overstappen aan â€”</div>
  <div class="clock" id="clock">--:--</div>
</div>

<div class="departures">
  <div class="list" id="leftList"></div>
  <div class="list" id="rightList"></div>
</div>

<script>
const API_KEY="ee23ac060f8a4038ad6d69358d85a1b0";
const MAX_PER_HALTE=7;
const COL_SIZE=6;
const TOTAL_SHOW=12;
const MAX_AANTAL_API=10;
const REFRESH_MS=15000;

const $=id=>document.getElementById(id);

/* ===== CLOCK ===== */
function pad(n){return String(n).padStart(2,"0")}
setInterval(()=>{
 const d=new Date();
 $("clock").textContent=`${pad(d.getHours())}:${pad(d.getMinutes())}`;
},1000);

/* ===== COLOR INVERSION ===== */
function invertColor(hex){
  if(!hex) return "#ffffff";
  hex=hex.replace("#","");
  if(hex.length===3) hex=hex.split("").map(c=>c+c).join("");

  const r=255-parseInt(hex.substr(0,2),16);
  const g=255-parseInt(hex.substr(2,2),16);
  const b=255-parseInt(hex.substr(4,2),16);

  return `rgb(${r},${g},${b})`;
}

/* ===== CSV ===== */
function parseCSV(l){
 let r=[],c="",q=false;
 for(let i=0;i<l.length;i++){
  const ch=l[i];
  if(ch=='"'){q=!q}
  else if(ch==","&&!q){r.push(c);c=""}
  else c+=ch;
 }
 r.push(c);return r;
}

/* ===== ROUTES ===== */
let routeMap=new Map();

async function loadRoutes(){
 const t=await fetch("./routes.txt").then(r=>r.text());
 const L=t.split(/\r?\n/).filter(l=>l);
 const h=parseCSV(L[0]);
 const id=h.indexOf("route_id");
 const sn=h.indexOf("route_short_name");
 const c=h.indexOf("route_color");
 const tc=h.indexOf("route_text_color");

 for(let i=1;i<L.length;i++){
  const r=parseCSV(L[i]);
  const p=r[id]?.slice(0,4);
  if(!routeMap.has(p))
   routeMap.set(p,{
     short:r[sn],
     bg:r[c],
     fg:r[tc]
   });
 }
}

/* ===== API ===== */
function ent(id){return parseInt(id[0])}

async function fetchStop(id){
 const u=`https://api.delijn.be/DLKernOpenData/api/v1/haltes/lijst/${ent(id)}_${id}/real-time?maxAantalDoorkomsten=${MAX_AANTAL_API}`;
 const d=await fetch(u,{headers:{"Ocp-Apim-Subscription-Key":API_KEY}}).then(r=>r.json());
 return d.halteDoorkomstenLijst?.flatMap(x=>x.halteDoorkomsten)||[];
}

/* ===== RENDER ===== */
function render(el,arr){
 el.innerHTML=arr.map(d=>{
  const k=String(ent(d.entiteitnummer)*1000+d.lijnnummer).slice(0,4);
  const r=routeMap.get(k)||{};
  const bg=r.bg?`#${r.bg}`:"var(--accent)";
  const fg=r.fg?`#${r.fg}`:"#000";
  const stroke=invertColor(fg);

  const iso=d["real-timeTijdstip"]||d.dienstregelingTijdstip;
  const min=Math.round((new Date(iso)-Date.now())/60000);
  const t=min<=0?"nu":`${min}'`;

  return `
  <div class="row">
   <div class="left">
    <span class="line-box"
      style="
        background:${bg};
        color:${fg};
        -webkit-text-stroke:2px ${stroke};
      ">${r.short||d.lijnnummer}</span>
    <span class="dest">${d.bestemming}</span>
   </div>
   <div class="time">${t}</div>
  </div>`;
 }).join("");
}

/* ===== MAIN ===== */
async function load(){
 await loadRoutes();
 const stop=new URLSearchParams(location.search).get("stopId");
 if(!stop) return;

 $("title").textContent=`Overstappen aan ${stop}`;

 const blocks=await fetchStop(stop);
 const all=blocks.flatMap(b=>b.doorkomsten.slice(0,MAX_PER_HALTE))
  .sort((a,b)=>new Date(a["real-timeTijdstip"]||a.dienstregelingTijdstip)-new Date(b["real-timeTijdstip"]||b.dienstregelingTijdstip));

 render(leftList,all.slice(0,COL_SIZE));
 render(rightList,all.slice(COL_SIZE,TOTAL_SHOW));
}

load();
setInterval(load,REFRESH_MS);
</script>
</body>
</html>
