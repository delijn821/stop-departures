<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Haltebord (De Lijn)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0b0f14; color: #e8eef6; }
    header { padding: 16px 18px; border-bottom: 1px solid #1b2633; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    header h1 { font-size: 16px; margin: 0; opacity: 0.9; }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .controls label { font-size: 12px; opacity: 0.85; display: flex; gap: 6px; align-items: center; }
    input, button { background: #121a24; color: #e8eef6; border: 1px solid #253448; border-radius: 10px; padding: 8px 10px; }
    button { cursor: pointer; }
    button:hover { filter: brightness(1.08); }
    main { padding: 18px; max-width: 980px; margin: 0 auto; }
    .meta { display: flex; justify-content: space-between; gap: 10px; flex-wrap: wrap; margin-bottom: 12px; }
    .pill { font-size: 12px; padding: 6px 10px; border: 1px solid #253448; border-radius: 999px; background: #0f1620; opacity: 0.95; }
    .error { border-color: #7a2c2c; background: #1a0f12; color: #ffb4b4; }
    table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 14px; border: 1px solid #253448; }
    thead { background: #0f1620; }
    th, td { padding: 12px 12px; border-bottom: 1px solid #1b2633; text-align: left; font-size: 14px; }
    th { font-size: 12px; letter-spacing: 0.02em; text-transform: uppercase; opacity: 0.8; }
    tbody tr:hover { background: #0f1620; }
    .line { font-weight: 700; }
    .muted { opacity: 0.75; font-size: 12px; }
    .delta { font-variant-numeric: tabular-nums; }
    .late { color: #ffcc66; }
    .early { color: #7ee787; }
    .rt { font-weight: 650; }
    .nowrap { white-space: nowrap; }
    .small { font-size: 12px; opacity: 0.85; }
  </style>
</head>

<body>
<header>
  <h1>Haltebord (De Lijn realtime)</h1>

  <div class="controls">
    <label>Entiteit
      <input id="entity" value="3" size="2" />
    </label>
    <label>Haltenummer
      <input id="stop" value="303467" size="8" />
    </label>
    <label>Max
      <input id="max" value="10" size="3" />
    </label>
    <label>Refresh (s)
      <input id="refresh" value="15" size="3" />
    </label>
    <label>API key
      <input id="key" placeholder="plak je key hier" size="24" />
    </label>
    <button id="loadBtn">Laden</button>
  </div>
</header>

<main>
  <div class="meta">
    <div class="pill" id="statusPill">Klaar.</div>
    <div class="pill" id="clockPill">--:--:--</div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Lijn</th>
        <th>Bestemming</th>
        <th class="nowrap">Realtime</th>
        <th class="nowrap">Dienstregeling</th>
        <th class="nowrap">+ / -</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="rows">
      <tr><td colspan="6" class="small muted">Vul je API key in en klik “Laden”.</td></tr>
    </tbody>
  </table>

  <p class="muted" style="margin-top:12px">
    Tip: op GitHub Pages blijft je API key zichtbaar voor anderen. Voor “echte” publicatie gebruik je best een proxy (zie onderaan).
  </p>
</main>

<script>
  const $ = (id) => document.getElementById(id);

  function pad2(n){ return String(n).padStart(2,'0'); }
  function fmtTime(iso){
    if(!iso) return "—";
    const d = new Date(iso);
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }
  function fmtHM(iso){
    if(!iso) return "—";
    const d = new Date(iso);
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }
  function diffMin(isoPlanned, isoRt){
    if(!isoPlanned || !isoRt) return null;
    const a = new Date(isoPlanned).getTime();
    const b = new Date(isoRt).getTime();
    return Math.round((b - a) / 60000); // minuten
  }
  function statusText(predArr){
    if(!Array.isArray(predArr) || predArr.length === 0) return "UNKNOWN";
    return predArr.join(", ");
  }

  function setStatus(text, isError=false){
    const el = $("statusPill");
    el.textContent = text;
    el.classList.toggle("error", !!isError);
  }

  async function loadDepartures(){
    const entiteit = $("entity").value.trim();
    const stop = $("stop").value.trim();
    const max = $("max").value.trim() || "10";
    const key = $("key").value.trim();

    if(!entiteit || !stop || !key){
      setStatus("Vul entiteit, halte en API key in.", true);
      return;
    }

    const url = `https://api.delijn.be/DLKernOpenData/api/v1/haltes/lijst/${entiteit}_${stop}/real-time?maxAantalDoorkomsten=${encodeURIComponent(max)}`;

    setStatus("Ophalen…");
    $("rows").innerHTML = `<tr><td colspan="6" class="small muted">Ophalen…</td></tr>`;

    try{
      const res = await fetch(url, {
        method: "GET",
        headers: {
          "Cache-Control": "no-cache",
          "Ocp-Apim-Subscription-Key": key
        }
      });

      if(!res.ok){
        const t = await res.text().catch(()=> "");
        throw new Error(`HTTP ${res.status} ${res.statusText} — ${t.slice(0,160)}`);
      }

      const data = await res.json();

      // pad veilig uit de response
      const lijst0 = data?.halteDoorkomstenLijst?.[0];
      const halteDoorkomsten0 = lijst0?.halteDoorkomsten?.[0];
      const doorkomsten = halteDoorkomsten0?.doorkomsten ?? [];

      if(doorkomsten.length === 0){
        $("rows").innerHTML = `<tr><td colspan="6" class="small muted">Geen doorkomsten gevonden.</td></tr>`;
        setStatus("Geen doorkomsten.");
        return;
      }

      // sorteer op realtime (of dienstregeling) tijd
      doorkomsten.sort((a,b)=>{
        const ta = new Date(a["real-timeTijdstip"] || a.dienstregelingTijdstip).getTime();
        const tb = new Date(b["real-timeTijdstip"] || b.dienstregelingTijdstip).getTime();
        return ta - tb;
      });

      const rows = doorkomsten.map(d => {
        const line = d.lijnnummer ?? "—";
        const dest = d.bestemmingKort || d.plaatsBestemming || d.bestemming || "—";
        const plannedIso = d.dienstregelingTijdstip;
        const rtIso = d["real-timeTijdstip"] || null;

        const planned = fmtHM(plannedIso);
        const rt = fmtHM(rtIso) || planned;

        const dm = diffMin(plannedIso, rtIso);
        let delta = "—";
        let deltaClass = "delta muted";
        if(dm !== null){
          if(dm > 0){ delta = `+${dm} min`; deltaClass = "delta late"; }
          else if(dm < 0){ delta = `${dm} min`; deltaClass = "delta early"; }
          else { delta = "op tijd"; deltaClass = "delta"; }
        }

        const st = statusText(d.predictionStatussen);
        const stText = rtIso ? st : "GEEN REALTIME";

        return `
          <tr>
            <td class="line">${line}</td>
            <td>${dest}<div class="muted">Richting: ${d.richting ?? "—"}</div></td>
            <td class="rt nowrap">${rt}</td>
            <td class="nowrap">${planned}</td>
            <td class="${deltaClass} nowrap">${delta}</td>
            <td class="nowrap">${stText}</td>
          </tr>
        `;
      }).join("");

      $("rows").innerHTML = rows;
      setStatus(`OK — ${doorkomsten.length} doorkomsten geladen.`);

    }catch(err){
      console.error(err);
      $("rows").innerHTML = `<tr><td colspan="6" class="small muted">Fout: ${String(err.message || err)}</td></tr>`;
      setStatus("Fout bij ophalen (mogelijk CORS of key).", true);
    }
  }

  // klok
  setInterval(()=>{
    const now = new Date();
    $("clockPill").textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())}`;
  }, 250);

  // refresh timer
  let timer = null;
  function startAutoRefresh(){
    if(timer) clearInterval(timer);
    const seconds = Math.max(5, parseInt($("refresh").value || "15", 10));
    timer = setInterval(loadDepartures, seconds * 1000);
  }

  $("loadBtn").addEventListener("click", ()=>{
    loadDepartures();
    startAutoRefresh();
  });

  // Enter = laden
  ["entity","stop","max","refresh","key"].forEach(id=>{
    $(id).addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        loadDepartures();
        startAutoRefresh();
      }
    });
  });
</script>
</body>
</html>
