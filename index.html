<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Overstappen</title>
  <style>
    :root{
      --accent:#FFCC11;
      --bg:#0b0f14;
      --panel:#101722;
      --line:#1b2633;
      --text:#e8eef6;
      --muted:rgba(232,238,246,.72);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    html,body{height:100%;}
    body{margin:0;background:var(--bg);color:var(--text);}

    header{
      padding:18px 18px 14px 18px;
      border-bottom:2px solid rgba(255,204,17,.35);
      background:linear-gradient(180deg, rgba(255,204,17,.10), transparent 65%);
    }
    h1{
      margin:0;
      font-size:18px;
      letter-spacing:.02em;
      font-weight:800;
    }

    main{max-width:980px;margin:0 auto;padding:18px;}

    table{
      width:100%;
      border-collapse:separate;border-spacing:0;
      overflow:hidden;border-radius:16px;
      border:1px solid var(--line);
      background:var(--panel);
    }
    thead th{
      text-align:left;font-size:12px;letter-spacing:.03em;
      text-transform:uppercase;color:rgba(232,238,246,.78);
      padding:12px 12px;border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.12);
    }
    tbody td{
      padding:12px 12px;border-bottom:1px solid rgba(27,38,51,.85);
      font-size:15px;
    }
    tbody tr:last-child td{border-bottom:none;}
    tbody tr:hover{background:rgba(255,255,255,.02);}

    .badge{
      display:inline-block;
      padding:6px 10px;border-radius:12px;
      font-weight:900;letter-spacing:.02em;
      font-variant-numeric: tabular-nums;
      min-width:52px;text-align:center;
      border:1px solid rgba(255,255,255,.12);
    }
    .badge.fallback{
      background:rgba(255,204,17,.18);
      color:#111;
      border-color:rgba(255,204,17,.40);
    }
    .dest{font-weight:650;}
    .depart{
      font-variant-numeric: tabular-nums;
      font-weight:900;
      white-space:nowrap;
    }
    .muted{color:var(--muted);font-size:12px;}
  </style>
</head>

<body>
<header>
  <h1 id="title">Overstappen aan —</h1>
</header>

<main>
  <table aria-label="Doorkomsten tabel">
    <thead>
      <tr>
        <th style="width:110px;">Lijn</th>
        <th>Bestemming</th>
        <th style="width:140px;">Vertrek</th>
      </tr>
    </thead>
    <tbody id="rows">
      <tr><td colspan="3" class="muted">Laden…</td></tr>
    </tbody>
  </table>
</main>

<script>
  // ========= CONFIG =========
  const API_KEY = "ee23ac060f8a4038ad6d69358d85a1b0";
  const MAX_AANTAL = 10;
  const REFRESH_MS = 15000;

  // ========= HELPERS =========
  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2, "0");

  function parseCSVLine(line){
    // simpele CSV parser met quotes (voldoende voor GTFS)
    const out = [];
    let cur = "", inQ = false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(ch === '"'){
        if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
        else inQ = !inQ;
      } else if(ch === "," && !inQ){
        out.push(cur);
        cur = "";
      } else {
        cur += ch;
      }
    }
    out.push(cur);
    return out;
  }

  function minutesUntil(iso){
    const t = new Date(iso).getTime();
    const now = Date.now();
    return Math.round((t - now) / 60000);
  }

  function formatMinutes(m){
    // altijd x' (ook als negatief)
    if(m <= 0) return "nu";
    return `${m}'`;
  }

  function getStopIdFromUrl(){
    const p = new URLSearchParams(location.search);
    return (p.get("stopId") || "").trim();
  }

  function getEntityFromStopId(stopId){
    const firstChar = stopId[0];
    const ent = parseInt(firstChar, 10);
    return Number.isNaN(ent) ? null : ent;
  }

  function cleanStopName(name){
    if(!name) return "";
    // knip vanaf: " perron", " opstaphalte", " afstaphalte", " quai", "," of "("
    const re = /(\s+perron\b|\s+opstaphalte\b|\s+afstaphalte\b|\s+quai\b|,|\()/i;
    const m = re.exec(name);
    const cut = m ? name.slice(0, m.index) : name;
    return cut.trim();
  }

  // ========= GTFS LOOKUPS =========
  // routes: prefix4 -> { shortName, color, textColor }
  let routeMap = new Map();
  // stops:
  //  - stopId -> rawName
  //  - cleanName -> [stopId, ...]
  let stopIdToName = new Map();
  let cleanNameToStopIds = new Map();

  async function loadRoutes(){
    const res = await fetch("./routes.txt", { cache: "no-store" });
    if(!res.ok) throw new Error(`routes.txt niet gevonden (HTTP ${res.status})`);
    const txt = await res.text();

    const lines = txt.split(/\r?\n/).filter(l => l.trim().length > 0);
    if(lines.length < 2) throw new Error("routes.txt lijkt leeg");

    const header = parseCSVLine(lines[0]).map(h => h.replace(/^"|"$/g,""));
    const idx = (name) => header.indexOf(name);

    const iRouteId = idx("route_id");
    const iShort   = idx("route_short_name");
    const iColor   = idx("route_color");
    const iTextCol = idx("route_text_color");

    if(iRouteId < 0 || iShort < 0) throw new Error("routes.txt mist route_id/route_short_name");

    const map = new Map();
    for(let li=1; li<lines.length; li++){
      const row = parseCSVLine(lines[li]);
      if(row.length !== header.length) continue;

      const routeIdRaw = (row[iRouteId] ?? "").replace(/^"|"$/g,"");
      if(routeIdRaw.length < 4) continue;

      const prefix4 = routeIdRaw.slice(0,4);
      if(!map.has(prefix4)){
        map.set(prefix4, {
          shortName: (row[iShort] ?? "").replace(/^"|"$/g,""),
          color: (row[iColor] ?? "").replace(/^"|"$/g,""),
          textColor: (row[iTextCol] ?? "").replace(/^"|"$/g,"")
        });
      }
    }
    routeMap = map;
  }

  async function loadStops(){
    const res = await fetch("./stops.txt", { cache: "no-store" });
    if(!res.ok) throw new Error(`stops.txt niet gevonden (HTTP ${res.status})`);
    const txt = await res.text();

    const lines = txt.split(/\r?\n/).filter(l => l.trim().length > 0);
    if(lines.length < 2) throw new Error("stops.txt lijkt leeg");

    const header = parseCSVLine(lines[0]).map(h => h.replace(/^"|"$/g,""));
    const idx = (name) => header.indexOf(name);

    const iStopId = idx("stop_id");
    const iStopName = idx("stop_name");
    if(iStopId < 0 || iStopName < 0) throw new Error("stops.txt mist stop_id/stop_name");

    const idToName = new Map();
    const cleanToIds = new Map();

    for(let li=1; li<lines.length; li++){
      const row = parseCSVLine(lines[li]);
      if(row.length !== header.length) continue;

      const stopId = (row[iStopId] ?? "").replace(/^"|"$/g,"").trim();
      const stopName = (row[iStopName] ?? "").replace(/^"|"$/g,"").trim();
      if(!stopId) continue;

      idToName.set(stopId, stopName);

      const clean = cleanStopName(stopName);
      if(!clean) continue;

      if(!cleanToIds.has(clean)) cleanToIds.set(clean, []);
      cleanToIds.get(clean).push(stopId);
    }

    stopIdToName = idToName;
    cleanNameToStopIds = cleanToIds;
  }

  // ========= API FETCH =========
  function buildHaltesLijstKey(stopIds){
    // "2_212223_2_212224" (entiteit = eerste cijfer stopId)
    // behoud volgorde zoals in stops.txt (die pushen we al in file-volgorde)
    const parts = [];
    for(const sid of stopIds){
      const ent = getEntityFromStopId(sid);
      if(ent === null) continue;
      parts.push(`${ent}_${sid}`);
    }
    return parts.join("_");
  }

  function getRouteBadge(doorkomst){
    const entiteit = Number(doorkomst.entiteitnummer);
    const lijnnr = Number(doorkomst.lijnnummer);

    const routeKeyNum = (entiteit * 1000) + lijnnr;
    const prefix4 = String(routeKeyNum).padStart(4, "0").slice(0,4);

    const route = routeMap.get(prefix4) || null;
    const shortName = route?.shortName || String(lijnnr);

    const bg = route?.color ? `#${route.color}` : null;
    const fg = route?.textColor ? `#${route.textColor}` : null;

    return { shortName, bg, fg };
  }

  async function loadBoard(){
    const stopId = getStopIdFromUrl();

    if(!stopId){
      $("title").textContent = "Overstappen";
      $("rows").innerHTML = `<tr><td colspan="3" class="muted">Gebruik ?stopId=123456</td></tr>`;
      return;
    }

    const rawName = stopIdToName.get(stopId) || "";
    const cleanName = cleanStopName(rawName) || "—";

    $("title").textContent = `Overstappen aan ${cleanName}`;
    document.title = `Overstappen aan ${cleanName}`;

    // alle stop_ids met dezelfde ingekorte naam
    const groupStopIds = cleanNameToStopIds.get(cleanName) || [stopId];

    const key = buildHaltesLijstKey(groupStopIds);
    if(!key){
      $("rows").innerHTML = `<tr><td colspan="3" class="muted">Geen geldige stop_ids gevonden.</td></tr>`;
      return;
    }

    const url = `https://api.delijn.be/DLKernOpenData/api/v1/haltes/lijst/${key}/real-time?maxAantalDoorkomsten=${MAX_AANTAL}`;

    try{
      const res = await fetch(url, {
        method: "GET",
        headers: {
          "Cache-Control": "no-cache",
          "Ocp-Apim-Subscription-Key": API_KEY
        }
      });

      if(!res.ok){
        const t = await res.text().catch(()=> "");
        throw new Error(`API fout: HTTP ${res.status} — ${t.slice(0,160)}`);
      }

      const data = await res.json();

      // De API kan meerdere halteDoorkomsten-blokken geven; we flatten alles samen
      const lijst = data?.halteDoorkomstenLijst?.[0]?.halteDoorkomsten || [];
      const all = [];
      for(const hd of lijst){
        const dks = hd?.doorkomsten || [];
        for(const d of dks) all.push(d);
      }

      if(!all.length){
        $("rows").innerHTML = `<tr><td colspan="3" class="muted">Geen doorkomsten.</td></tr>`;
        return;
      }

      all.sort((a,b)=>{
        const ta = new Date(a["real-timeTijdstip"] || a.dienstregelingTijdstip).getTime();
        const tb = new Date(b["real-timeTijdstip"] || b.dienstregelingTijdstip).getTime();
        return ta - tb;
      });

      const rowsHtml = all.map(d => {
        const { shortName, bg, fg } = getRouteBadge(d);

        const badgeStyle = bg ? `background:${bg};color:${fg || "#000"};` : ``;
        const badgeClass = bg ? "badge" : "badge fallback";

        const bestemming = d.bestemming ?? "—";

        // Vertrek altijd x' — realtime indien beschikbaar, anders dienstregeling
        const iso = d["real-timeTijdstip"] || d.dienstregelingTijdstip || null;
        const vertrekTxt = iso ? formatMinutes(minutesUntil(iso)) : "—";

        return `
          <tr>
            <td><span class="${badgeClass}" style="${badgeStyle}">${shortName}</span></td>
            <td class="dest">${bestemming}</td>
            <td class="depart">${vertrekTxt}</td>
          </tr>
        `;
      }).join("");

      $("rows").innerHTML = rowsHtml;

    } catch(err){
      console.error(err);
      $("rows").innerHTML = `<tr><td colspan="3" class="muted">Fout: ${String(err.message || err)}</td></tr>`;
    }
  }

  // ========= BOOT =========
  (async () => {
    try{
      await Promise.all([loadRoutes(), loadStops()]);
    }catch(e){
      console.error(e);
      $("title").textContent = "Overstappen";
      $("rows").innerHTML = `<tr><td colspan="3" class="muted">GTFS bestanden konden niet geladen worden.</td></tr>`;
      return;
    }

    await loadBoard();
    setInterval(loadBoard, REFRESH_MS);
  })();
</script>
</body>
</html>
